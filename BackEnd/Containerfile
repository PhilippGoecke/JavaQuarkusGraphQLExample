FROM debian:trixie-slim as build-env

ARG DEBIAN_FRONTEND=noninteractive

RUN apt update && apt upgrade -y \
    && apt install -y --no-install-recommends --no-install-suggests curl \
    && apt install -y --no-install-recommends --no-install-suggests openjdk-21-jdk maven \
    && rm -rf "/var/lib/apt/lists/*" \
    && rm -rf /var/cache/apt/archives

ARG USER=quarkus
RUN useradd --create-home --shell /bin/bash $USER
ARG HOME="/home/$USER"
WORKDIR $HOME
USER $USER

RUN curl -Ls https://sh.jbang.dev/ --output jbang.bash \
    && echo "229dfd76ab1ac0753ac8eed6c81c24619c83d6a194de995910a0aa485aabd14fc8014db4216d9bababb0d68410194145ec1af8ae19b81132f178ff23ed3aed77 jbang.bash" > jbang.bash.sha512 \
    && sha512sum -c jbang.bash.sha512 \
    && cat jbang.bash | bash -s - trust add https://repo1.maven.org/maven2/io/quarkus/quarkus-cli/ \
    && cat jbang.bash | bash -s - app install --fresh --force quarkus@quarkusio

ENV PATH="/home/$USER/.jbang/bin:${PATH}"

RUN quarkus create app todo-app \
    --extension='smallrye-graphql,hibernate-orm-panache,jdbc-postgresql,resteasy-reactive' \
    && cd todo-app
# RUN quarkus extension add smallrye-graphql

WORKDIR "/home/$USER/todo-app"

RUN cat > src/main/java/org/acme/Todo.java <<'EOF'
package org.acme;

import io.quarkus.hibernate.orm.panache.PanacheEntity;
import jakarta.persistence.Entity;

@Entity
public class Todo extends PanacheEntity {
    public String title;
    public String description;
    public boolean completed;
}
EOF

RUN cat > src/main/java/org/acme/TodoResource.java <<'EOF'
package org.acme;

import org.eclipse.microprofile.graphql.GraphQLApi;
import org.eclipse.microprofile.graphql.Mutation;
import org.eclipse.microprofile.graphql.Query;
import jakarta.transaction.Transactional;
import java.util.List;

@GraphQLApi
public class TodoResource {

    @Query("allTodos")
    public List<Todo> getAllTodos() {
        return Todo.listAll();
    }

    @Query("todo")
    public Todo getTodo(Long id) {
        return Todo.findById(id);
    }

    @Mutation("createTodo")
    @Transactional
    public Todo createTodo(String title, String description) {
        Todo todo = new Todo();
        todo.title = title;
        todo.description = description;
        todo.completed = false;
        todo.persist();
        return todo;
    }

    @Mutation("updateTodo")
    @Transactional
    public Todo updateTodo(Long id, String title, String description, Boolean completed) {
        Todo todo = Todo.findById(id);
        if (todo != null) {
            if (title != null) todo.title = title;
            if (description != null) todo.description = description;
            if (completed != null) todo.completed = completed;
        }
        return todo;
    }

    @Mutation("deleteTodo")
    @Transactional
    public boolean deleteTodo(Long id) {
        return Todo.deleteById(id);
    }
}
EOF

RUN cat > src/main/resources/application.properties <<'EOF'
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=quarkus
quarkus.datasource.password=quarkus
quarkus.datasource.jdbc.url=jdbc:postgresql://host.containers.internal:5432/todos
quarkus.hibernate-orm.database.generation=drop-and-create
EOF

RUN ./mvnw test --fail-at-end

EXPOSE 8888

ENV QUARKUS_HTTP_PORT="8888"
ENV QUARKUS_HTTP_HOST="0.0.0.0"
ENV QUARKUS_HTTP_CORS="true"
ENV QUARKUS_HTTP_CORS_ORIGINS="*"

CMD [ "./mvnw", "quarkus:run" ]

HEALTHCHECK CMD curl -f "http://localhost:8888/graphql/schema.graphql" || exit 1
